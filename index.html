<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ê²Œì‹œíŒ (ë°±ì—”ë“œ ì—°ë™ ì™„ë£Œ)</title>
    <style>
      body {
        font-family: "Noto Sans KR", sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f4f4f9;
      }
      h1,
      h2 {
        color: #333;
      }
      .container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }
      input,
      textarea {
        width: 100%;
        padding: 10px;
        margin-bottom: 10px;
        box-sizing: border-box;
        border: 1px solid #ddd;
        border-radius: 4px;
      }
      button {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 4px;
        cursor: pointer;
      }
      button:hover {
        background-color: #0056b3;
      }
      button.secondary {
        background-color: #6c757d;
      }
      .post-item {
        border-bottom: 1px solid #eee;
        padding: 15px 0;
      }
      .post-meta {
        font-size: 0.85em;
        color: #666;
        margin-bottom: 5px;
      }
      .hidden {
        display: none;
      }
      #error-msg {
        color: red;
        margin-bottom: 10px;
      }
    </style>
  </head>
  <body>
    <h1>ğŸ“¢ ê²Œì‹œíŒ ì„œë¹„ìŠ¤</h1>
    <div id="error-msg"></div>

    <div id="auth-section" class="container">
      <h2 id="auth-title">ë¡œê·¸ì¸</h2>
      <input type="text" id="username" placeholder="ì•„ì´ë””" />
      <input type="password" id="password" placeholder="ë¹„ë°€ë²ˆí˜¸" />
      <input
        type="email"
        id="email"
        placeholder="ì´ë©”ì¼ (íšŒì›ê°€ì… ì‹œ í•„ìš”)"
        class="hidden"
      />
      <input
        type="text"
        id="name"
        placeholder="ì´ë¦„ (íšŒì›ê°€ì… ì‹œ í•„ìš”)"
        class="hidden"
      />
      <input
        type="text"
        id="url"
        placeholder="í”„ë¡œí•„ ì´ë¯¸ì§€ URL (ì„ íƒ)"
        class="hidden"
      />

      <button id="login-btn" onclick="login()">ë¡œê·¸ì¸</button>
      <button id="signup-btn" onclick="signup()" class="hidden">
        ê°€ì…í•˜ê¸°
      </button>
      <button class="secondary" onclick="toggleAuthMode()">
        íšŒì›ê°€ì…/ë¡œê·¸ì¸ ì „í™˜
      </button>
    </div>

    <div id="main-section" class="container hidden">
      <div
        style="
          display: flex;
          justify-content: space-between;
          align-items: center;
        "
      >
        <h2 id="welcome-msg">í™˜ì˜í•©ë‹ˆë‹¤!</h2>
        <button class="secondary" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
      </div>

      <hr />

      <h3>ìƒˆ ê¸€ ì‘ì„±</h3>
      <textarea
        id="post-text"
        rows="3"
        placeholder="ë¬´ìŠ¨ ìƒê°ì„ í•˜ê³  ê³„ì‹ ê°€ìš”?"
      ></textarea>
      <button onclick="createPost()">ê²Œì‹œ</button>

      <hr />

      <h3>ê¸€ ê²€ìƒ‰</h3>
      <div style="display: flex; gap: 10px">
        <input type="text" id="search-userid" placeholder="ì‘ì„±ì IDë¡œ ê²€ìƒ‰" />
        <button onclick="getPosts()">ê²€ìƒ‰</button>
      </div>

      <hr />

      <h3>íƒ€ì„ë¼ì¸</h3>
      <div id="post-list">
        <p>ë¡œë”© ì¤‘...</p>
      </div>
    </div>

    <script>
      // --- ì„¤ì • ë° ìƒíƒœ ---
      const BASE_URL = "http://127.0.0.1:8080"; // ì„œë²„ ì£¼ì†Œ (í•„ìš”ì‹œ ë³€ê²½)
      let isLoginMode = true;
      let token = localStorage.getItem("token");

      // --- ì´ˆê¸°í™” ---
      checkLoginStatus();

      // --- ì¸ì¦ ê´€ë ¨ í•¨ìˆ˜ ---
      function toggleAuthMode() {
        isLoginMode = !isLoginMode;
        document.getElementById("auth-title").innerText = isLoginMode
          ? "ë¡œê·¸ì¸"
          : "íšŒì›ê°€ì…";
        document.getElementById("login-btn").classList.toggle("hidden");
        document.getElementById("signup-btn").classList.toggle("hidden");

        // íšŒì›ê°€ì… ì „ìš© í•„ë“œ í† ê¸€
        ["email", "name", "url"].forEach((id) => {
          document.getElementById(id).classList.toggle("hidden");
        });
      }

      async function signup() {
        const username = document.getElementById("username").value;
        const password = document.getElementById("password").value;
        const email = document.getElementById("email").value;
        const name = document.getElementById("name").value;
        const url = document.getElementById("url").value;

        try {
          const res = await fetch(`${BASE_URL}/auth/signup`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username, password, email, name, url }),
          });
          const data = await res.json();

          if (res.ok) {
            alert("ê°€ì… ì„±ê³µ! ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
            toggleAuthMode();
          } else {
            showError(data.message || "ê°€ì… ì‹¤íŒ¨");
          }
        } catch (e) {
          showError("ì„œë²„ ì—°ê²° ì˜¤ë¥˜");
        }
      }

      async function login() {
        const username = document.getElementById("username").value;
        const password = document.getElementById("password").value;

        try {
          const res = await fetch(`${BASE_URL}/auth/login`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username, password }),
          });
          const data = await res.json();

          if (res.ok) {
            token = data.token; // í† í° ì €ì¥
            localStorage.setItem("token", token);
            localStorage.setItem("username", username); // í¸ì˜ìƒ ì €ì¥
            checkLoginStatus();
          } else {
            showError(data.message || "ë¡œê·¸ì¸ ì‹¤íŒ¨");
          }
        } catch (e) {
          showError("ì„œë²„ ì—°ê²° ì˜¤ë¥˜");
        }
      }

      function logout() {
        token = null;
        localStorage.removeItem("token");
        localStorage.removeItem("username");
        checkLoginStatus();
      }

      function checkLoginStatus() {
        const authSection = document.getElementById("auth-section");
        const mainSection = document.getElementById("main-section");

        if (token) {
          authSection.classList.add("hidden");
          mainSection.classList.remove("hidden");
          document.getElementById(
            "welcome-msg"
          ).innerText = `${localStorage.getItem("username")}ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤!`;
          getPosts(); // ë¡œê·¸ì¸ ì‹œ ê¸€ ëª©ë¡ ë¡œë“œ
        } else {
          authSection.classList.remove("hidden");
          mainSection.classList.add("hidden");
        }
      }

      // --- ê²Œì‹œê¸€ ê´€ë ¨ í•¨ìˆ˜ ---

      // ê¸€ ëª©ë¡ ì¡°íšŒ (ê²€ìƒ‰ í¬í•¨)
      async function getPosts() {
        const searchUserid = document.getElementById("search-userid").value;
        // ê²€ìƒ‰ì–´ê°€ ìˆìœ¼ë©´ ?userid=ê²€ìƒ‰ì–´ íŒŒë¼ë¯¸í„° ì¶”ê°€
        const query = searchUserid
          ? `?username=${encodeURIComponent(searchUserid)}`
          : "";
        // ì£¼ì˜: ë°±ì—”ë“œ ì½”ë“œì— ë”°ë¼ ?userid= ì¸ì§€ ?username= ì¸ì§€ í™•ì¸ í•„ìš”í•˜ë‚˜,
        // ìš”ì²­í•˜ì‹  ì‚¬í•­ì— "ê²€ìƒ‰: ?userid=ê²€ìƒ‰ì–´"ë¼ê³  í•˜ì…”ì„œ useridë¡œ ì„¤ì •í•©ë‹ˆë‹¤.
        // ë§Œì•½ ë°±ì—”ë“œê°€ usernameì„ ë°›ëŠ”ë‹¤ë©´ ì•„ë˜ urlì„ ìˆ˜ì •í•˜ì„¸ìš”.

        const url = `${BASE_URL}/post${
          searchUserid ? `?userid=${searchUserid}` : ""
        }`;

        try {
          const res = await fetch(url, {
            headers: { Authorization: `Bearer ${token}` },
          });
          const data = await res.json();

          if (res.ok) {
            renderPosts(data);
          } else {
            // 401ì´ë©´ í† í° ë§Œë£Œ ê°€ëŠ¥ì„±
            if (res.status === 401) logout();
          }
        } catch (e) {
          console.error(e);
        }
      }

      // ê¸€ ì‘ì„±
      async function createPost() {
        const text = document.getElementById("post-text").value;

        if (!text) return alert("ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”");

        try {
          // ìš”ì²­í•˜ì‹  ì‚¬í•­ ë°˜ì˜: title ì—†ì´ textë§Œ ì „ì†¡
          const res = await fetch(`${BASE_URL}/post`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({ text }),
          });

          if (res.ok) {
            document.getElementById("post-text").value = ""; // ì…ë ¥ì°½ ì´ˆê¸°í™”
            getPosts(); // ëª©ë¡ ê°±ì‹ 
          } else {
            alert("ê¸€ ì‘ì„± ì‹¤íŒ¨");
          }
        } catch (e) {
          console.error(e);
        }
      }

      // í™”ë©´ ë Œë”ë§
      function renderPosts(posts) {
        const list = document.getElementById("post-list");
        list.innerHTML = "";

        // postsê°€ ë°°ì—´ì¸ì§€ í™•ì¸ (ë°±ì—”ë“œ ì‘ë‹µ êµ¬ì¡°ì— ë”°ë¼ data.data ì¼ìˆ˜ë„ ìˆìŒ)
        const postArray = Array.isArray(posts) ? posts : posts.data || [];

        if (postArray.length === 0) {
          list.innerHTML = "<p>ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
          return;
        }

        postArray.forEach((post) => {
          const div = document.createElement("div");
          div.className = "post-item";

          // ë‚ ì§œ í¬ë§·íŒ…
          const date = new Date(post.createdAt).toLocaleString();

          div.innerHTML = `
                    <div class="post-meta">
                        <strong>${
                          post.username || post.userId || "ìµëª…"
                        }</strong> | ${date}
                    </div>
                    <div class="post-content">${post.text}</div>
                `;
          list.appendChild(div);
        });
      }

      function showError(msg) {
        const el = document.getElementById("error-msg");
        el.innerText = msg;
        setTimeout(() => (el.innerText = ""), 3000);
      }
    </script>
  </body>
</html>
